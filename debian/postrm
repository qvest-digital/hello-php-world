#!/bin/sh
# From MirOS: contrib/hosted/tg/deb/jupp/debian/jupp.postrm,v 1.2 2011/09/06 20:07:39 tg Exp $

set -e

# This maintainer script can be called the following ways:
#
# * postrm "remove"
# * postrm "purge"
# * old-postrm "upgrade" $new_version
# * disappearers-postrm "disappear" $overwriter $o_version
# The package's files have been removed or replaced; only Essential pak-
# kages may be available; skip gracefully actions requiring Depends.
#
# * new-postrm "failed-upgrade" $old_version
# Called when 'old-postrm "upgrade"' fails; the new package is unpacked,
# Essential packages and Pre-Depends are available; the latter have been
# configured and never removed but may be Unpacked or Half-Configured.
#
# * new-postrm "abort-install" [$old_version]
# * new-postrm "abort-upgrade" $old_version
# Called when preinst fails; package is not unpacked. Essential packages
# and (unpacked or Half-Configured) Pre-Depends are available.

if test -e /usr/share/apache2/apache2-maintscript-helper; then
	. /usr/share/apache2/apache2-maintscript-helper
fi
do_webserver_config() {
	# set up Apache configuration
	local apache22common_state

	apache22common_state=$(dpkg-query -f '${Status}' -W 'apache2.2-common' \
	    2>/dev/null | awk '{print $3}' || :)

	if test -e /usr/share/apache2/apache2-maintscript-helper; then
		# Apache 2.4
		apache2_invoke disconf hello-php-world || exit $?
	elif test x"$apache22common_state" = x"installed" || \
	    test x"$apache22common_state" = x"unpacked"; then
		# Apache 2.2
		test '!' -L /etc/apache2/conf.d/hello-php-world.conf || \
		    rm /etc/apache2/conf.d/hello-php-world.conf
	else
		# neither Apache 2.2 nor Apache 2.4
		echo >&2 "I: no web server configured for hello-php-world"
	fi
}

# Initialise debconf
. /usr/share/debconf/confmodule
# Initialise dbconfig-common
dbc_generate_include_owner=root:www-data
dbc_generate_include_perms=0640
dbc_generate_include=php:/var/lib/hello-php-world/dbconfig.inc
dbc_pgsql_createdb_encoding=UTF8
dbc_authmethod_user=password
if test -f /usr/share/dbconfig-common/dpkg/postrm.pgsql; then
	. /usr/share/dbconfig-common/dpkg/postrm.pgsql
	dbc_go hello-php-world "$@"
fi

# custom actions
case $1 in
remove)
	do_webserver_config
	;;

purge)
	do_webserver_config
	rm -f /var/lib/hello-php-world/dbconfig.inc
	if which ucf >/dev/null 2>&1; then
		ucf --purge /var/lib/hello-php-world/dbconfig.inc
		ucfr --purge hello-php-world /var/lib/hello-php-world/dbconfig.inc
	fi
	rm -rf /var/lib/hello-php-world
	;;

upgrade|disappear|failed-upgrade|abort-install|abort-upgrade)
	;;

*)
	echo >&2 "postrm called with unknown subcommand '$1'"
	exit 1
	;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
